name: "Comment or delete"
description: "Adds a comment to an issue or deletes it based on a provided condition"
inputs:
  issue_number:
    description: "The issue's number"
    required: true
  marker:
    description: "The comment marker"
    default: ""
    required: true
  body:
    description: "The comment body"
    required: true
  condition:
    description: "The condition to evaluate"
    required: true
runs:
  using: "composite"
  steps:
    - uses: actions/github-script@v2
      with:
        issue_number: ${{ inputs.issue_number }}
        marker: ${{ inputs.marker }}
        body: ${{ inputs.body }}
        condition: ${{ inputs.condition }}
        script: |
          const marker = core.getInput("marker");
          const body = core.getInput("body");
          const condition = core.getInput("condition");
          const issue_number = core.getInput("issue");

          console.log("Issue number", issue_number);

          github.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue_number,
          }).then(function(comments) {
            const comment = comments.data.find(c => c.user.login === "github-actions" && c.body.includes(marker));
            console.log("Comment", comment);

            if (condition) {
              // condition evaluates true, we need to add or update a comment

              if (comment) {
                // update
                github.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                  body: body
                });
              } else {
                // add
                github.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  body: body
                });
              }

            } else if (comment) {
              // condition evaluates false but there's a comment, we need to delete the comment

              github.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id
              });
            }
          });
